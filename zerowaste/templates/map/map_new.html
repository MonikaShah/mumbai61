{% extends 'map/map_base.html' %}
{% load static%}{% load has_group %}
{% block extra_map_css %}
{% load i18n %}

<!-- import psycopg2 -->
<style>
  .border {
    padding: 6px 8px;
    border-style: groove;
    border-radius: 5px;
    margin: 20px;
  }

  .info {
    padding: 6px 8px;
    font: 14px/16px Arial, Helvetica, sans-serif;
    background: rgba(255, 255, 255, 0.8);
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    border-radius: 5px;
  }

  .info h4 {
    margin: 0 0 5px;
    color: #777;
  }

  /* .table{
  border-collapse: collapse;
  padding: 50px;
  font-weight: bold;

  
  /* background:rgba(191, 149, 233, 0.473); */

  /* } */


  /* table{
    width: 350px;
  } */
  table,
  th,
  td {
    border-bottom: 1px solid #ddd;
    border-collapse: collapse;
    width: 600px !important;
    /* padding: 2px 3px; */
    /* text-align: center; */
  }

  th {
    font-weight: bold;
  }

  .legend {
    line-height: 18px;
    color: #555;
  }

  .legend i {

    width: 18px;
    height: 18px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
  }

  .legendwet {
    line-height: 18px;
    color: #555;
  }

  .legendwet i {
    width: 18px;
    height: 18px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
  }

  /* css to customize Leaflet default styles  */
  .leaflet-popup-content-wrapper {
    width: 400px;
    background: rgba(0, 0, 0, 0.9);
    color: #ffffff;
  }

  .leaflet-popup-content {
    font-weight: bold;
  }

  /* css for table tbinfo*/
  #tbinfo {
    font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
    border-collapse: collapse;
    font-weight: bolder;
  }

  #tbinfo td,
  #tbinfo th {
    border: 3px solid #ddd;
    /* padding: 8px; */
  }

  #tbinfo tr:nth-child(even) {
    background-color: #f2f2f2;
  }

  #tbinfo tr:hover {
    background-color: rgb(194, 92, 92);
  }

  #tbinfo th {
    padding-top: 12px;
    padding-bottom: 12px;
    text-align: left;
    background-color: #4CAF50;
    color: white;
  }

  #checkboxes {
    display: none;
    /* border: 1px #dadada solid; */
  }

  #datepick {
    display: none;
    /* border: 1px #dadada solid; */
  }
#side-bar{
  min-height: min-content;
  max-height: 700px;
  overflow-y: scroll;
}
  #checkboxes label {
    display: block;
    text-decoration-color: blue;
    text-align: left;
    margin: 10px;
  }
#formBtn{
  background-color: rgb(131, 131, 241)78, 78, 80);
}

  #checkboxes8 {
    display: none;
    /* border: 1px #dadada solid; */
  }

  .legend{
    background-color: white;
  }
  #checkboxes8 label {
    display: block;
    text-decoration-color: blue;
    text-align: left;
    margin: 10px;
  }

  #checkboxes3,#mumbai_whole,#ward_check {
    display: none;
    /* border: 1px #dadada solid; */
  }

  #checkboxes3 label {
    display: block;
    background-color: white;
    text-decoration-color: blue;
    text-align: left;
    margin: 10px;
  }

  #checkboxes7 {
    display: none;
    /* border: 1px #dadada solid; */
  }

  #kwestbuilding,#ward_checklist {
    display: none;

  }

  #checkboxes7 label,#mumbai_whole label,#ward_check label,#ward_check select {
    display: block;
    text-align: left;
    margin: 10px;
  }

  
  /* Popup container - can be anything you want */
  .popup {
    position: relative;
    display: inline-block;
    cursor: pointer;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    left: 50%;
    margin-right: -5px;
    border-width: 5px;
  }

  /* The actual popup */
  .popup .popuptext {
    visibility: hidden;
    width: 260px;
    background-color: #555;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 8px 0;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    margin-left: -80px;
  }

  /* Popup arrow */
  .popup .popuptext::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #555 transparent transparent transparent;
  }

  /* Toggle this class - hide and show the popup */
  .popup .show {
    visibility: visible;
    -webkit-animation: fadeIn 1s;
    animation: fadeIn 1s;
  }

  /* Add animation (fade in the popup) */
  @-webkit-keyframes fadeIn {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  .form-control {
    width: 160px;
  }

  .circle {
    /* background-color: red; */
    border-radius: 50%;
  }
</style>

{% endblock extra_map_css%}

{% block map_content%}
<!-- {% block sidebar %}
  {% endblock %} -->
  {% if messages %}
  <div>
  <ul class="messages">
      {% for message in messages %}
  
      <div class="alert alert-success alert-dismissible fade show" role="alert">
          {{message}}
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
      </div>
  
      {% endfor %}
  </ul>
  </div>
  {% endif %}

<div id="side-bar" style="background-color:  rgba(255, 255, 255);">
  <!-- side-bar container -->

  <div class="mobileShow">

    <div style="text-align: center">
      <button style="display: inline-block ;position: relative; background: #000; opacity: 0.60;" id="closebutton"
        name="closebutton" class="btn btn-secondary"><span class="fa fa-bars"></span></button>
    </div>

  </div>
  <div>
    <div class="text-center border">


      <form id="projectList" style="width: 100%">

        <form>
          <div class="multiselect">
            <div class="selectBox" onclick="showCheckboxes11('mumbai')">
              <button type="button" disabled class="btn btn-outline-dark" style="width: 90%;font-size:12px; "> {% trans "Mumbai Layers _ 2022 rev" %}</button>
              <div class="overSelect"></div><br>
            </div>
          <div class="selectBox" onclick="showCheckboxes3('mumbai')">
            <button type="button" class="btn btn-outline-dark" style="width: 90%;font-size:12px; "> {% trans "Mumbai Layers" %}</button>
            <div class="overSelect"></div>
          </div>

         
              <div id="mumbai_whole">
                <div class="checkbox">
                  <label><input type="checkbox" style = "margin: 0 0 0 17px;"value="{mumbai_ward}" id="mumbai_ward" onchange="getBoundaryru(this)"><span> {% trans "Ward Boundaries" %}</span></label>
                </div>
                <div class="checkbox">
                  <label><input type="checkbox" style = "margin: 0 0 0 17px;"value="{mumbai_prabhag}" id="mumbai_prabhag" onchange="getBoundaryru(this)"><span> {% trans "Prabhag Boundaries" %}</span></label>
                </div>
                <div class="checkbox">
                  <label><input type="checkbox" style = "margin: 0 0 0 17px;" value="{mumbai_buildings}" id="mumbai_buildings" onclick="getBoundaryru(this)"><span> {% trans "Building points :Whole Mumbai" %}</span></label>
                </div>
                <div class="checkbox">
                  <label><input type="checkbox" style = "margin: 0 0 0 17px;" value="{DP}" id="DP" onclick="getBoundaryru(this)"><span> {% trans "Development Plan :Whole Mumbai" %}</span></label>
                </div>
                <hr><label for="" style="margin: 0 0 0 37px; font-weight: bolder;">Building Points: Selected Parts</label>
              <label for="" style="text-align: center; font-weight: bolder;">Ward wise</label>
              <select class="custom-select" name="dist_select" id="wardlistwms"> 
                <option selected disabled>Select ward</option>
                {% for dist_select in ward_list %}
                <option value="{{ dist_select.ward_id }}">{{ dist_select.ward_name_field }}
                </option>
                {% endfor %}
            </select>
            <label for=""  style="text-align: center; font-weight: bolder;">Prabhag wise</label>
            <select class="custom-select" name="dist_select" id="prabhaglistwms">
              <option selected disabled>Select Prabhag</option>
              <!-- {% for dist_select in prabhag_mumbai %}
              <option value="{{ dist_select.prabhag_no }}">{{ dist_select.prabhag_no }}
              </option>
              {% endfor %} -->
          </select><hr>
        </div>
        <br>

          <div class="multiselect">
            <div class="selectBox" onclick="showCheckboxes3('geo')">
              <button type="button" class="btn btn-outline-dark addMore" title = "More interactions are enable here  as a Pilot area"style="width: 90%;font-size:12px; " title="More interactions have been enable here  as a Pilot area"> {% trans "Focus: K-West Pilot" %}</button>
              <div class="overSelect"></div>
            </div>
             <div id="checkboxes3">
              <!-- <div class="checkbox" id="boundary">
                <label><input type="checkbox" value="Mumbai Suburban" onchange="getBoundaryru(this)"><span> {% trans  "Mumbai Suburban Boundary" %}</span></label>
              </div> -->
              
              <div class="checkbox" id="boundary">
                <label><input type="checkbox" value="{wardKWest}" onchange="getBoundaryru(this)"><span> {% trans "K-WEST" %}</span></label>
                <div>
                  <div id="kwestbuilding">
                    <div class="checkbox" style = "margin: 0 0 0 17px;">
                      <label><input type="checkbox" value="{cop}" id="cop" onchange="getBoundaryru(this)"><span> {% trans "Prabhag Boundaries" %}</span></label>
                    </div>
                    <div class="checkbox" style = "margin: 0 0 0 17px;">
                      <label><input type="checkbox" value="{kwest-buildings}" id="buildings" onclick="getBoundaryru(this)"><span> {% trans "K-West Building Points" %}</span></label>
                    </div>
                  </div>
              </div>
              <div class="checkbox">
                <label><input type="checkbox"  value="{61bound}" onchange="getBoundaryru(this)"><span> {% trans "Prabhag 61" %}</span></label>
              </div>
              <div id="checkboxes4">
                <div class="checkbox">
                  <label><input type="checkbox" value="{kwestbeat}"  id="kwestbeat"
                      onchange="getBoundaryru(this)"><span> {% trans "K-West Sweep Beats" %}</span></label>
                </div>
              </div>

            </div>
          </div> 

           <br> 
          {% if request.user|has_group:"wardEditor" %}
          <div class="multiselect">
            <div class="selectBox" onclick="showCheckboxes3('ward')">
              <button type="button" class="btn btn-outline-dark" id="ward" style="width: 90%;font-size:12px; "> {% trans " " %}</button>
              <div class="overSelect"></div>
            </div>
            <div id="ward_check">
              <select class="custom-select" name="dist_select" id="prabhaglist">
                    <option selected disabled>Select Prabhag</option>
                    {% for dist_select in prabhag_list %}
                    <option value="{{ dist_select.prabhag_no }}">{{ dist_select.prabhag_no }}
                    </option>
                    {% endfor %}
                </select>
              <div id="ward_checklist">
                <div class="checkbox">
                  <label><input type="checkbox" value="{regions}" disabled id="regions" onchange="getBoundaryru(this)"><span> {% trans "Regions" %}</span></label>
                </div>
                <div class="checkbox">
                  <label><input type="checkbox" value="{buildings}" disabled id="buildings"
                      onchange="getBoundaryru(this)"><span> {% trans "Buildings Clusters" %}</span></label>
                </div>
           
                <div class="checkbox">
                  <label><b><input type="checkbox" value="{buildings}" id="{buildings}"
                        onchange="getBoundaryru(this)"><span> {% trans "Building Points:Prabhag Wise" %}</span></b></label>
                </div>
                {% if request.user.role == "MO" and request.user|has_group:"wardEditor" or request.user|has_group:"prabhagEditor" %}

                <div class="checkbox">
                  <label><b><input type="checkbox" value="{buildings_up}" id="{buildings}"
                        onchange="getBoundaryru(this)"><span> {% trans "Building Points:updated Yesterday" %}</span></b></label>
                </div>
                {% endif %}
             

                <div class="checkbox">
                  <label><input type="checkbox" style = "margin: 0 0 0 17px;"value="{sra}" id="sra" disabled onchange="getBoundaryru(this)"><span> {% trans "SRA" %}</span></label>
                </div>
                <div class="checkbox">
                  <label><input type="checkbox" style = "margin: 0 0 0 17px;"value="{chs}" id="chs" disabled onchange="getBoundaryru(this)"><span> {% trans "CHS" %}</span></label>
                </div>
                <div class="checkbox">
                  <label><input type="checkbox" style = "margin: 0 0 0 17px;"value="{smpa}" id="smpa" disabled onchange="getBoundaryru(this)"><span>
                      {% trans "SMPA" %}</span></label>
                </div>

                <div class="checkbox">
                  <label><input type="checkbox" value="{roads}" id="roads"  onchange="getBoundaryru(this)"><span> {% trans "Roads" %}</span></label>
                </div>
              </div> 
              </div>
             
            {% endif %}

          {% if request.user|has_group:"prabhagEditor" %}
            <div class="multiselect">
              <div class="selectBox" onclick="showCheckboxes3('prabhag')">
                <button type="button" class="btn btn-outline-dark" id="prabhag" style="width: 90%;font-size:12px; "> {% trans " " %}</button>
                <div class="overSelect"></div>
              </div>
              <div id="checkboxes7">
                <div class="checkbox">
                  <label><input type="checkbox" value="{regions}" id="regions" disabled onchange="getBoundaryru(this)"><span> {% trans "Regions" %}</span></label>
                </div>
                <div class="checkbox">
                  <label><input type="checkbox" value="{buildings}" disabled id="buildings"
                      onchange="getBoundaryru(this)"><span> {% trans "Buildings Clusters" %}</span></label>
                </div>
           
                <div class="checkbox">
                  <label><b><input type="checkbox" value="{buildings}" id="{buildings}"
                        onchange="getBoundaryru(this)"><span> {% trans "Building points :Prabhag Wise" %}</span></b></label>
                </div>
             
              
              

                <div class="checkbox">
                  <label><input type="checkbox" style = "margin: 0 0 0 17px;"value="{sra}" id="sra" disabled onchange="getBoundaryru(this)"><span> {% trans "SRA" %}</span></label>
                </div>
                <div class="checkbox">
                  <label><input type="checkbox" style = "margin: 0 0 0 17px;"value="{chs}" id="chs" disabled onchange="getBoundaryru(this)"><span> {% trans "CHS" %}</span></label>
                </div>
                <div class="checkbox">
                  <label><input type="checkbox" style = "margin: 0 0 0 17px;"value="{smpa}" id="smpa" disabled onchange="getBoundaryru(this)"><span>
                      {% trans "SMPA" %}</span></label>
                </div>

                <div class="checkbox">
                  <label><input type="checkbox" value="{roads}" id="roads" onchange="getBoundaryru(this)"><span> {% trans "Roads" %}</span></label>
                </div>
                <!--Restricted access  -->
                <!-- {% if request.user|has_group:"Editor" %}
                <div class="checkbox">
                  <label><input type="checkbox" value="{buildings_noname}" id="buildings_noname"
                      onchange="getBoundaryru(this)"><span> {% trans "UnNamed Buildings" %}</span></label>
                </div>
                <div class="checkbox">
                  <label><input type="checkbox" value="{regions_noname}" id="regions_noname"
                      onchange="getBoundaryru(this)"><span> {% trans "Unamed Regions in Buildings" %}</span></label>
                </div>
                {% endif %} -->
                <!-- <div class="checkbox">
                            <label><input type="checkbox" value="{roads}" id ="buildingsosm" onchange="displayPoint()"><span> {% trans "OSM BUILDINGS" %}</span></label>
                          </div>                       -->

              </div>
              {% endif %}
              <br>
              <div class="multiselect">
                <div class="selectBox" onclick="showCheckboxes3('bwg')">
                  <button type="button" class="btn btn-outline-dark" style="width: 90%;font-size:12px; "> {% trans "Bulk Waste Generators" %}</button>
                  <div class="overSelect"></div>
                </div>
                <div id="checkboxes8">
                  <div class="checkbox">
                    <label><input type="checkbox" value="{bwg_city}" id="bwg_city" onchange="getBoundaryru(this)"><span> {% trans "Mumbai City BWG" %}</span></label>
                  </div>
                  <div class="checkbox">
                    <label><input type="checkbox" value="{bwg_es}" id="bwg_es" onchange="getBoundaryru(this)"><span> {% trans "Mumbai Eastern Suburbs BWG" %}</span></label>
                  </div>
                  <div class="checkbox">
                    <label><input type="checkbox" value="{bwg_ws}" id="bwg_ws" onchange="getBoundaryru(this)"><span> {% trans "Mumbai Western Suburbs BWG" %}</span></label>
                  </div>
               <!-- <button type="button" class="btn btn-primary" id='locate'>{% trans "Your Location" %}</button> -->
            </div>

          </div>

        </form>


      </form>
      {% endblock map_content%}
      {% block extra_map_javascript%}
<script src="{% static 'tilelayer-leaflet.js' %}"></script>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
      <script src="https://d3js.org/d3.v4.js"></script>

<!-- Create a div where the graph will take place -->

      <script>
        let area = null;
        var legend;
        let windowWidth = window.screen.width;
  let windowHeight = window.screen.height;
        let expanded = false;
        console.log(expanded)
        let wms_legend,popup_layer;
        let newLayerList = [];
        var polylayer;
        var polylayer2 =[];
        var kwestlayer = [];
        var areaLayerList=[];
        var markerClusters = L.markerClusterGroup({"chunkedLoading": true});
        let buildings_up = [];
        let buildings = {{ geojson|safe }};
        let ward= '{{ward}}';
        let prabhag = '{{prabhag}}';
        // console.log(prabhag)

        $('#prabhag').html('Prabhag '+prabhag +' landmarks')
        $('#ward').html('Ward '+ward +' landmarks')
        function showCheckboxes3(th) {
          let checkboxes;
          if (th == 'geo') {
            checkboxes = document.getElementById("checkboxes3");

          }
          else if (th == 'prabhag') {
            checkboxes = document.getElementById("checkboxes7");

          }
          else if (th == 'bwg') {
            checkboxes = document.getElementById("checkboxes8");

          }
          else if (th == 'mumbai') {
            checkboxes = document.getElementById("mumbai_whole");

          }
          else if (th == 'ward') {
            checkboxes = document.getElementById("ward_check");

          }
          if (!expanded) {
            checkboxes.style.display = "block";
            expanded = true;
          } else {
            checkboxes.style.display = "none";
            expanded = false;
          }
        }
        // var prabhag_sel;
        $("#prabhaglist").change(function() {
	 var $endpoint = window.location.href // or localhost/interface
	 prabhag = $(this).val();
  //  console.log(prabhag)
 

   if(polylayer != undefined){
     console.log(polylayer,"poly")
     removeWMS('Buildings_mumbai:mumbai_roads_prabhag_wise_29jan');
   removepolylayer(polylayer);
    document.getElementById("{buildings}").checked = false;
    // console.log(document.getElementById("{roads}").checked)
  document.getElementById("roads").checked = false;
  }
	 $name1= {
            
			'name1': prabhag}
 		 $.ajax({
                method: "GET",
                url: $endpoint,
                data: $name1,
                success:function(data) {
                  if(data.length == 2){
                    buildings = JSON.parse(data.geojson);
          buildings_up = JSON.parse(data.geojson1)
                  }
					else{
            buildings = JSON.parse(data);
buildings_up = [];
          }
          // prabhag= data.prabhag;
//           var checkboxes = document.getElementById("ward_checklist");

          ward_checklist.style.display = "block";
expanded = true;
          // displaypolygon('{buildings}');
				}
  		});
})

function setView1(layerName,val, selectedBoundary) {
    if (area) {
        mymap.removeLayer(area);
    }
    let rootUrl = 'https://geoserver2.communitygis.net/geoserver/'+layerName.split(":")[0]+'/ows';

    let options = {
        service: 'WFS',
        version: '1.0.0',
        request: 'GetFeature',
        outputFormat: 'application/json',
        typeName: layerName,
        cql_filter: `${val}='${selectedBoundary}'`,
        propertyName: 'the_geom'
    };
    let parameters = L.Util.extend(options);
    layer_url = rootUrl + L.Util.getParamString(parameters)
    fetch(layer_url).then(
        function(response) {
            if (response.status !== 200) {
                console.log('Looks like there was a problem. Status Code: ' +
                    response.status);
                return;
            }
            response.json().then(function(geojsonData) {
                area = L.geoJson(geojsonData.features)
                console.log(area)
                lat = area.getBounds()._northEast.lat
                lng = area.getBounds()._northEast.lng
                mymap.setView([lat, lng], 14)
            });
        }).catch(function(err) {
        console.log('Fetch Error :-S', err);
    });
}
let wardwms;
let prabhagwms_list;
$("#wardlistwms").change(function() {
	//  var $endpoint = window.location.href // or localhost/interface
  layer = 'Buildings_mumbai:Buildings_mumbai';
  wardwms = $(this).val();
   var wms_layer = L.tileLayer.wms('https://geoserver2.communitygis.net/geoserver/wms', {
                layers: 'Buildings_mumbai:Buildings_mumbai',
                format: 'image/png',
                transparent: 'true',
                cql_filter: `ward_id_2='${wardwms}'`,
              });
              wms_layer.addTo(mymap);
popup_layer = "https://geoserver2.communitygis.net/geoserver/"+layer.split(":")[0]+"/wms?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&LAYERS=" + wms_layer.options.layers + "&QUERY_LAYERS=" + wms_layer.options.layers;
              removeWMS('Buildings_mumbai:Buildings_mumbai');

              newLayerList.push(wms_layer);
              setView1('Buildings_mumbai:Buildings_mumbai','ward_id_2', wardwms);
              let $name2= {            
            'name2':wardwms}
            var $endpoint = window.location.href // or localhost/interface
  var popup = new L.Popup({
                    maxWidth: 300
                });
  $.ajax({
                method: "GET",
                url: $endpoint,
                data: $name2,
                success: function(data) {
                  for (i = 0; i < data.length; i++) {
  var opt = document.createElement("option");
  document.getElementById("prabhaglistwms").innerHTML += '<option id="' + data[i].prabhag_no + '">' + data[i].prabhag_no+ '</option>';
}
                }
              })
              // mymap.setView([19.1186, 72.8064], 13);
})
$("#prabhaglistwms").change(function() {
	//  var $endpoint = window.location.href // or localhost/interface
	 var selectedValue = $(this).val();
   var wms_layer = L.tileLayer.wms('https://geoserver2.communitygis.net/geoserver/wms', {
                layers: 'Buildings_mumbai:Buildings_mumbai',
                format: 'image/png',
                transparent: 'true',
                cql_filter: `prabhag_no='${selectedValue}'`,

              });
              wms_layer.addTo(mymap);
              removeWMS('Buildings_mumbai:Buildings_mumbai');
              newLayerList.push(wms_layer);

              setView1('Buildings_mumbai:Buildings_mumbai','prabhag_no', selectedValue);
})
        function getBoundaryru(obj) {
          
          let boundary = obj.value;
          console.log("boundary is :"+boundary);
          if ($(obj).is(":checked")) {

            if (boundary == "Mumbai Suburban") {
              var wms_layer = L.tileLayer.wms('https://geoserver2.communitygis.net/geoserver/wms', {
                layers: 'geonode:maha_taluka_13march2021',
                format: 'image/png',
                transparent: 'true',
                cql_filter: `distname='${boundary}'`,

              });
              wms_layer.addTo(mymap);
              newLayerList.push(wms_layer);

              mymap.setView([19.1186, 72.8064], 11);
            }
            else if (boundary == '{kwestbeat}'){
              putfrmgeo(kwestbeat);
              // var wms_layer = L.tileLayer.wms('https://gis.communitygis.net/geoserver/wms', {
              //   layers: 'geonode:k_west_beat_22jan',
              //   format: 'image/png',
              //   transparent: 'true',
              //   // cql_filter: `distname='${boundary}'`,

              // });
              
              // wms_layer.addTo(mymap);
              // newLayerList.push(wms_layer);

              // mymap.setView([19.1233, 72.7784], 13);
            }
            else if (boundary == '{bwg_city}'){
              putfrmgeo(bwg_city);
            
             }
            else if (boundary == '{bwg_ws}'){
              
              putfrmgeo(bwg_ws);
              
            }
            else if (boundary == '{bwg_es}'){
              
              putfrmgeo(bwg_es);
            }
            else if (boundary == "{wardKWest}") {
              
              putWMSru("ward61:k_west_mumbai");
              var checkboxes = document.getElementById("kwestbuilding");

              kwestbuilding.style.display = "block";
              expanded = true;

            }


            else if (boundary == "{61bound}" )
              putWMSru("ward61:ward61_boundary_1nov21");
            else if (boundary == "{regions}")
              putWMSru("ward61:regions_6dec21");

            else if (boundary == "{buildings}")
              displaypolygon(boundary);
            else if (boundary == "{buildings_up}")
              displaypolygon(boundary);
            else if (boundary == "{buildings_only}")
              putWMSru("ward61:osm_buildings_29oct21");
            else if (boundary == "{roads}"){
            var wms_layer = L.tileLayer.wms('https://geoserver2.communitygis.net/geoserver/wms', {
                layers: 'Buildings_mumbai:mumbai_roads_prabhag_wise_29jan',
                format: 'image/png',
                transparent: 'true',
                cql_filter: `prabhag_no='${prabhag}'`,

              });
              wms_layer.addTo(mymap);
              newLayerList.push(wms_layer);
              addWMSLegend('Buildings_mumbai:mumbai_roads_prabhag_wise_29jan');
              setView1('Buildings_mumbai:Buildings_mumbai','prabhag_no', prabhag);}
            else if(boundary == '{cop}')
              putWMSru("kwest_corporator_ward_31st_dec");
            else if (boundary == "{buildings_noname}")
              displaypolygon(boundary);
            else if (boundary == "{regions_noname}")
              displaypolygon(boundary);
            else if (boundary == "{kwest-buildings}")
              {  putWMSru("ward61:k-west_building");}
              else if (boundary == "{mumbai_ward}")
              putWMSru("Buildings_mumbai:mumbai_ward_boundary_2Jan2022");
              else if (boundary == "{mumbai_prabhag}")
              putWMSru("Buildings_mumbai:Corporate_Ward_Boundaries_8jan");
              else if (boundary == "{mumbai_buildings}")
              putWMSru("Buildings_mumbai:Buildings_mumbai");
              else if (boundary == "{DP}")
              putWMSru("Buildings_mumbai:mumbai_city_3july2021");

          } else {
            if (boundary == "{wardKWest}") {
              removeWMS("ward61:k_west_mumbai")
              removeWMS("ward61:k-west_building")
              removeWMS("kwest_corporator_ward_31st_dec");
              kwestbuilding.style.display = "none";
              expanded = false;
            }
            else if(boundary =="{kwestbeat}")
                removeWMS("geonode:k_west_beat_22jan")
            else if (boundary == "{bwg_city}")
              removeWMS("geonode:BWG_City_29Jan");
            else if (boundary == "{bwg_ws}")
              removeWMS("geonode:BWG_WS_27Jan2022");
            else if (boundary == "{bwg_es}")
              removeWMS("BWG_ES_29Jan");
            else if (boundary == "Mumbai Suburban")
              removeWMS("geonode:maha_taluka_13march2021");
            else if (boundary == "{kwest-buildings}")
              removeWMS("ward61:k-west_building");
            else if (boundary == "{regions}")
              removeWMS("ward61:regions_6dec21");
            else if (boundary == "{61bound}")
              removeWMS("ward61:ward61_boundary_1nov21");
            else if (boundary == "{cop}")
              removeWMS("kwest_corporator_ward_31st_dec");
              else if (boundary == "{mumbai_ward}")
              removeWMS("Buildings_mumbai:mumbai_ward_boundary_2Jan2022");
              else if (boundary == "{mumbai_prabhag}")
              removeWMS("Buildings_mumbai:Corporate_Ward_Boundaries_8jan");
              else if (boundary == "{mumbai_buildings}")
              removeWMS("Buildings_mumbai:Buildings_mumbai");

              else if (boundary == "{DP}")
              removeWMS("Buildings_mumbai:mumbai_city_3july2021");
            else if (boundary == "{buildings}") {
              removepolylayer(polylayer);
  mymap.removeControl(legend);

            }
            else if (boundary == "{buildings_up}") {
              removepolylayer(polylayer);
  mymap.removeControl(legend);

            }
            else if (boundary == "{roads}")
              removeWMS('Buildings_mumbai:mumbai_roads_prabhag_wise_29jan');
            else if (boundary == "{buildings_noname}")
              removepolylayer(polylayer);
            else if (boundary == "{regions_noname}")
              removepolylayer(polylayer);
          };


        }
        function removeWMS(unchecked_layer) {
          newLayerList.forEach((layer, index) => {
            if (layer.options.layers === unchecked_layer) {
             
              mymap.removeLayer(layer);
              newLayerList.splice(index, 1);
              if (wms_legend) {
                mymap.removeControl(wms_legend);
              }
              addWMSLegend(layer);

            }
          });
          
        }
        function removepolylayer(layer){
    mymap.removeLayer(layer);
    // mymap.removeControl(wms_legend);
    // mymap.clearLayers();
}
        function putfrmgeo(layers) {
          // alert(layers.value)
          // alert(layers);
          var obj = layers.value;
          console.log(obj);
          if (obj == "{kwestbeat}") {
           
            layer = 'geonode:k_west_beat_22jan';
            var currentPos = [19.1211, 72.8155];
            var maximumzoom = 19;
            // var opac = 0.6;
            var zoom = 13;

          }
          else if (obj == '{bwg_city}'){
            layer = 'geonode:BWG_City_29Jan';
            var currentPos = [18.9944, 72.8043];
            var maximumzoom = 19;
            // tranparent = true;
            // var opac = 0.7;
            var zoom = 12;
            
      
          }
          else if (obj == '{bwg_ws}'){
            layer = 'geonode:BWG_WS_27Jan2022';
            var currentPos = [19.1337, 72.7954];
            var maximumzoom = 19;
            // var opac = 0.3;
            var zoom = 13;
      
          }
          else if (obj == '{bwg_es}'){
            layer = 'BWG_ES_29Jan';
            var currentPos = [19.1022, 72.8752];
            var maximumzoom = 19;
            // var opac = 1.0;
            var zoom = 13;
      
          }
          var wms_layer1 = L.tileLayer.wms('https://gis.communitygis.net/geoserver/wms', {
            layers: layer,
            format: 'image/png',
            
            // opacity: opac,
            transparent: true,
            currentPos:[19.1233, 72.7784],
            maxZoom: maximumzoom,
            // style: subteStyle(feature),

          });
          wms_layer1.addTo(mymap);
          mymap.setView(currentPos, zoom);
          newLayerList.push(wms_layer1);
          popup_layer = "https://gis.communitygis.net/geoserver/wms?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&LAYERS=" + wms_layer1.options.layers + "&QUERY_LAYERS=" + wms_layer1.options.layers;
        }
        // Set up styles for subway lines
        // function subteStyle(feature) {
        //   var colorToUse;
        //   var line = feature.properties.daily_wast;
        //   alert("in style");
        //   if (line >= "500") colorToUse = "#46C7FA";
        //   // else if (line === "LINEA B") colorToUse = "#E81D1A";
        //   // else if (line === "LINEA C") colorToUse = "#4161BA";
        //   // else if (line === "LINEA D") colorToUse = "#599C65";
        //   // else if (line === "LINEA E") colorToUse = "#65018A";
        //   // else if (line === "LINEA H") colorToUse = "#FAF739";
        //   else colorToUse = "#000000";
                    
        //   return {
        //     "color": colorToUse,
        //     "weight": 5
        //   };
        // }
        function putWMSru(layer) {
          if (layer == "ward61:k_west_mumbai") {
            layer = 'ward61:k_west_mumbai';
            currentPos = [19.1233, 72.7784];
            var maximumzoom = 19;
            var opac = 0.6;
            var zoom = 13;

          }
          else if (layer == "ward61:regions_6dec21") {
            currentPos = [19.1467, 72.8283];
            var maximumzoom = 20;
            var opac = 0.5;
            var zoom = 16;
          }
          else if (layer == "ward61:ward61_boundary_1nov21") {
            currentPos = [19.1423, 72.8137];
            var maximumzoom = 20;
            var opac = 0.5;
            var zoom = 13;
          }
          else if (layer == "ward61:osm_buildings_29oct21") {
            currentPos = [19.1467, 72.8283];
            layer = "";
            var maximumzoom = 20;
            var opac = 0.1;
            var zoom = 16;

          }
          else if (layer == "ward61:ward61osmroad25OCT") {
            currentPos = [19.1467, 72.8283];
            var maximumzoom = 20;
            var opac = 0.5;
            var zoom = 16;
          }
          else if (layer == "Buildings_mumbai:Corporate_Ward_Boundaries_8jan"){
            currentPos = [19.1467, 72.8283];
            var maximumzoom = 20;
            var opac = 0.3;
            var zoom = 12;
          }
          else if (layer == "Buildings_mumbai:mumbai_ward_boundary_2Jan2022"){
            currentPos = [19.1467, 72.8283];
            var maximumzoom = 20;
            var opac = 0.3;
            var zoom = 12;
          }
else{
  currentPos = [19.1467, 72.8283];
            var maximumzoom = 20;
            var opac = 1;
            var zoom = 12;
}
          var wms_layer = L.tileLayer.wms('https://geoserver2.communitygis.net/geoserver/wms', {
            layers: layer,
            format: 'image/png',
            opacity: opac,
            transparent: true,
            maxZoom: maximumzoom,

          });
          wms_layer.addTo(mymap);
          mymap.setView(currentPos, zoom);
          newLayerList.push(wms_layer);
          popup_layer = "https://geoserver2.communitygis.net/geoserver/"+layer.split(":")[0]+"/wms?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&LAYERS=" + wms_layer.options.layers + "&QUERY_LAYERS=" + wms_layer.options.layers;
         
          if (wms_legend) {
            mymap.removeControl(wms_legend);
          }

          addWMSLegend(layer);
        }
        function onEachFeatureForPointBB(feature, layer) {
         let variable = feature.properties.validity;
         console.log(typeof variable)
var today = new Date();
let time = today.toLocaleString();

         // alert(layer.properties.name+"="+feature);
    // layer.on({click:onClick })
    // if(${feature.properties.name} !== null){
    layer.bindPopup(`<div class = 'text-left'><label>Hello ! {{ request.user.username }}. </lable><form method="POST" class="post-form" action="/buildupdate/${feature.properties.sac_number}" style="margin-top: 20px; width:400px">
        {% csrf_token %}
        <table class="table-bordered table-striped">
            <tr><td align ="left"><label class="required">{% trans "SAC Number" %}</label></td><td><input type="text" disabled name="sac" id="id_sac" value="${feature.properties.sac_number}" /></td></tr>
            <tr><td align ="left"><label>{% trans "Region Name:" %}</label></td><td><input type="text" name="region" id="id_region" value="${feature.properties.region}" /></td></tr>
            <tr class="blank_row"></tr>
            
            <tr><td align ="left"><label>{% trans "Building Name:" %}</label></td><td><input type="text" name="building_name" id="id_building_name" value="${feature.properties.building_name}" /></td></tr>
            <tr class="blank_row"></tr>
            <tr><td align ="left">{% trans "Building Type:" %}</td><td><input type="text" name="building_type" id="id_building_type" value="${feature.properties.building_type}" /></td></tr>
            <tr class="blank_row"></tr>
            <tr><td align ="left">{% trans "Wing Name:" %}</td><td><input type="text" name="wing_name" id="id_wing_name" value="${feature.properties.wing_name}" /></td></tr>
            <tr class="blank_row"></tr>
            <tr><td align ="left"><label>{% trans "Number of Flats:" %}</label></td><td><input type="number" name="num_flat" id="id_num_flat"  value="${feature.properties.num_flat}" /></td></tr>
            <tr class="blank_row"></tr>
            <tr><td align ="left">{% trans "Number of Shops:" %}</td><td><input type="number" name="num_shops" id="id_num_shops"  value="${feature.properties.num_shops}" /></td></tr>
            <tr class="blank_row"></tr>
           
            
            <tr><td align ="left">{% trans "Village:" %}</td><td><input type="text" name="village" id="id_village" value="${feature.properties.village}" /></td></tr>
            <tr class="blank_row"></tr>
            
            <tr><td align ="left">{% trans "Billing Address:" %}</td><td><input type="text" name="address" id="id_address" value="${feature.properties.address}" /></td></tr>
            <tr class="blank_row"></tr>
            <tr><td align ="left">{% trans "Property Address:" %}</td><td><input type="text" name="address" id="id_address" value="${feature.properties.prop_add}" /></td></tr>
            <tr class="blank_row"></tr>    
            {% if request.user.role != "MO" and request.user|has_group:"wardEditor" or request.user|has_group:"prabhagEditor" %}
            <tr hidden><td align ="left">{% trans "Validity:" %}</td><td><input type="text" disabled name="validity" id="id_validity" value="${feature.properties.validity}" /></td></tr>
            <tr class="blank_row"></tr>    
            {% elif request.user.role == "MO" and request.user|has_group:"wardEditor" or request.user|has_group:"prabhagEditor" %}
            <tr hidden><td align ="left">{% trans "Validity:" %}</td><td><input type="text" disabled name="validity" id="id_validity" value="True" /></td></tr>
            <tr class="blank_row"></tr>  
            {% endif %}
            <tr disaled><td align ="left">{% trans "Updated By:" %}</td><td> <input type="text" name="updated_by" required   id="id_updated_by" value="{{ request.user.username }}" /></td></tr>
            <tr class="blank_row"></tr>
            <tr disabled><td align ="left">{% trans "Update Time:" %}</td><td><input type="text" name="update_time" required   id="id_update_time" value="${time}" /></td></tr>
            <tr class="blank_row"></tr>
            <tr><td align ="left">{% trans "Device IP:" %}</td><td><input type="text" name="device_ip" disabled id="id_device_ip" value="" /></td></tr>
            <tr class="blank_row"></tr>
        </table>
       
        <div class="form-group row">
            <label class="col-sm-1 col-form-label"></label>
            <div class="col-sm-4">
                <button type="submit" class="btn btn-success">{% trans "Update" %}</button>

            </div>
        </div>
        
    </form>
    {% if request.user|has_group:"wardEditor" or request.user|has_group:"prabhagEditor" and request.user.role == "MO" %}
        <div class="form-group row">
            <label class="col-sm-1 col-form-label"></label>
            <div class="col-sm-4">
           
                <button type="submit"
                {% if '{{ ${variable}|yesno:"yeah" }}' %} 
                class="btn btn-success"
                {% elif '${variable}' is not false %}
                class="btn btn-danger"
              
                {% endif%}
                 id="validate" onclick="validate('${feature.properties.sac_number}')">{% trans "Authenticate" %}</button>

            </div>
        </div>
        {% endif %}
    <tr ><td colspan =2 ><a href='/garbage_seg/' class="btn btn-success">Add Waste Segregation Details</a></td></tr></div>`
//       <table border =2><tr class="bg-primary"><td colspan=2>Building Information</td></tr>
//       <tr><td><b>SAC No.: </b></td><td> ${feature.properties.sac_number} </td></tr>
//                         <tr><td><b>Building Name: </b></td><td>${feature.properties.building_name} </td></tr>
//                         <tr><td><b>Description: </b></td><td>${feature.properties.building_type} </td></tr>
//                         <tr><td><b>Region: </b></td><td> ${feature.properties.region} </td></tr>
//                         <tr><td><b>Number of Flats: </b></td><td> ${feature.properties.num_flat} </td></tr>
//                         <tr><td><b>Number of shops: </b></td><td> ${feature.properties.num_shops} </td></tr>
//                         <tr><td><b>Number of Wings></td><td> ${feature.properties.wing_name} </td></tr>
//                           <tr><td><b>Prabhag: </b></td><td> ${feature.properties.prabhag_no} </td></tr>
//                         <tr><td><b>Ward: </b></td><td>${feature.properties.ward_name_field} </td></tr>
      
//                         <tr><td><b>Village: </b></td><td> ${feature.properties.village} </td></tr>
//                         <tr><td><b>Billing Address: </b></td><td>${feature.properties.address} </td></tr>
//                         <tr><td><b>Property Address: </b></td><td>${feature.properties.prop_add} </td></tr>
      
// `
// +
// `

//      <tr ><td colspan =2><b><center><a href = '/buildedit/${feature.properties.sac_number}' class="btn btn-info">Update Building Details</a></center></td></tr>
//      <tr ><td colspan =2 ><a href='/garbage_seg/' class="btn btn-success">Add Waste Segregation Details</a></td></tr></table>

// `+`</table>

)


// document.getElementById("validate").classList.remove('btn-danger');
//           }
//           else{
//             document.getElementById("validate").classList.add('btn-danger');

// document.getElementById("validate").classList.remove('btn-success');
//           }

}
function validate(id){
  let url_val = "/buildupdate/"+id+"-Auth";
  console.log(id,url_val)

  $.ajax({
        url: url_val,
        dataType: "json",
        type: "GET",
        success: function(data) {
          $('#validate').removeClass('btn-danger');
$('#validate').addClass('btn-success');
        }
      })


}
var geojsonMarkerOptions = {
    radius: 3,
    fillColor: "#ff7800",
    color: "#000",
    weight: 1,
    opacity: 1,
    fillOpacity: 0.8
};
function displaypolygon(poly_layer){
  let building_data;
  if(poly_layer == '{buildings}' ){
building_data = buildings.features;

  }
  else if(poly_layer=='{buildings_up}'){
    building_data= buildings_up.features;
  }

  if(building_data !=undefined){
    polylayer = L.geoJSON(building_data, {
        pointToLayer: function (feature, latlng) {
        return L.circleMarker(latlng, geojsonMarkerOptions)},
        style:function(feature){
          if(feature.properties.validity == true){
            if(feature.properties.building_name != null & feature.properties.num_flat != null & feature.properties.address !=null &feature.properties.prop_add != null & feature.properties.building_type != null & feature.properties.wing_name !=null & feature.properties.num_shops != null & feature.properties.village != null){
              return {color:"#000",fillColor:"green"};
            }
            else  if(feature.properties.building_name != null){
              return {color:"#000",fillColor:"yellow"};
            }
            }
            else if(feature.properties.validity == false){
              if(feature.properties.building_name != null){
                return {color:"#000",fillColor:"grey"};
              }
              else if(feature.properties.building_name == null){
                return {color:"#000",fillColor:"red"};
              }
            }

        // switch(feature.properties.validity){
          
        //     case false :
        //       switch(feature.properties.building_name){ case null:return {color:"#000",fillColor:"red"};}
        //     case true:
              
        
        // default:return {color:"#000",fillColor:"green"};
        //     // case 'apartments':return {color:"#000",fillColor:"red"};
        //     // // case 'yes':return {color:"#c83daa"};
        //     // case 'commercial':return {color:"#000",fillColor:"#55e232"};
        //     // case 'COMMERCIAL':return {color:"#000",fillColor:"#55e232"};
        //     // case 'office':return {color:"#000",fillColor:"#7d3fe9"};
        //     // case 'yes':return {color:"#000",fillColor:"#c83daa"};
        //     // case 'school':return {color:"#000",fillColor:"#efe115"};
        //     }
        },    
        
    
        onEachFeature: onEachFeatureForPointBB,
    });
    // legend.style.display = "block";

// var svg = d3.select("#my_dataviz")
// // Handmade legend
// svg.append("circle").attr("cx",windowWidth/1.1).attr("cy",windowHeight/2).attr("r", 6).style("fill", "#69b3a2")
// svg.append("circle").attr("cx",200).attr("cy",160).attr("r", 6).style("fill", "#404080")
// svg.append("text").attr("x", 220).attr("y", 130).text("variable A").style("font-size", "15px").attr("alignment-baseline","middle")
// svg.append("text").attr("x", 220).attr("y", 160).text("variable B").style("font-size", "15px").attr("alignment-baseline","middle")
 legend = L.control({position: 'bottomright'});
legend.onAdd = function(mymap) {
  var div = L.DomUtil.create("div", "legend");
  div.innerHTML += "<h4>Color codes</h4>";
  div.innerHTML += '<i style="background: green"></i><span>Complete and authorized data.</span><br>';
  div.innerHTML += '<i style="background: yellow"></i><span>Incomplete and authorized data.</span><br>';
  div.innerHTML += '<i style="background: grey"></i><span>Building name available and unauthorized data.</span><br>';
  div.innerHTML += '<i style="background: red"></i><span>Building name is null and unauthorized data.</span><br>';
  let btn = document.createElement("button");
btn.innerHTML = "View as table";
btn.id = "formBtn";

btn.onclick = function () {
  let url_val = "/table/"+poly_layer+prabhag;

  window.location.href = url_val;

};
div.appendChild(btn);
  // div.innerHTML += '<i style="background: #FFFFFF"></i><span>Ice</span><br>';
  // div.innerHTML += '<i class="icon" style="background-image: url(https://d30y9cdsu7xlg0.cloudfront.net/png/194515-200.png);background-repeat: no-repeat;"></i><span>Grænse</span><br>';
  
  

  return div;
};
console.log(legend,"legend");
legend.addTo(mymap);
    setView1('Buildings_mumbai:Buildings_mumbai','prabhag_no', prabhag);
  polylayer.addTo(mymap);

    // layer ="ward61:osm_buildings_29oct21";
    // addWMSLegend(layer);
  

  }
  else if(building_data == undefined){
    polylayer = {};
 legend = L.control({position: 'bottomright'});
legend.onAdd = function(mymap) {
  var div = L.DomUtil.create("div", "legend");
  div.innerHTML += "<h4>No Data updated yesterday.</h4>";
  // div += '<button style="background: #FFFFFF"></i><span>Ice</span><br>';
  // div.innerHTML += '<i class="icon" style="background-image: url(https://d30y9cdsu7xlg0.cloudfront.net/png/194515-200.png);background-repeat: no-repeat;"></i><span>Grænse</span><br>';
  
  

  return div;
};

legend.addTo(mymap);
    setView1('Buildings_mumbai:Buildings_mumbai','prabhag_no', prabhag);
    polylayer.addTo(mymap);
  }
  else if(poly_layer == '{buildings_noname}'){
    polylayer = L.geoJSON(osm_buildings,{
        pointToLayer: function (feature, latlng) {
        return L.circleMarker(latlng, geojsonMarkerOptions)},
        style:function(feature){
        switch(feature.properties.building_type){
            case 'residence':return {color:"#000",fillColor:"red"
        };
            case 'RESIDENTIAL':return {color:"#000",fillColor:"red"};
            case 'apartments':return {color:"#000",fillColor:"red"};
            // case 'yes':return {color:"#c83daa"};
            case 'commercial':return {color:"#000",fillColor:"#55e232"};
            case 'COMMERCIAL':return {color:"#000",fillColor:"#55e232"};
            case 'office':return {color:"#000",fillColor:"#7d3fe9"};
            case 'yes':return {color:"#000",fillColor:"#c83daa"};
            case 'school':return {color:"#000",fillColor:"#efe115"};
            }
        },    
        
    
        onEachFeature: onEachFeatureForUpdationK_west,
    });
  }
  else if(poly_layer =="{regions_noname}"){
    polylayer = L.geoJSON(osm_buildings, 
    {style:function(feature){
        switch(feature.properties.building_type){
            case 'residence':return {color:"#FF0000"};
            case 'residential':return {color:"#FF0000"};
            case 'apartments':return {color:"#FF0000"};
            // case 'yes':return {color:"#c83daa"};
            case 'commercial':return {color:"#FF0000"};
            case 'Commercial':return {color:"#FF0000"};
            case 'office':return {color:"#FF0000"};
            case 'yes':return {color:"#FF0000"};
            case 'school':return {color:"#FF0000"};
            }
        },    
        
        onEachFeature: onEachFeatureForPointBB,
        filter: NonameRegionFilter,
    // }).addTo(mymap);
    });
  }
}
        function addWMSLegend(layer) {
          lagendGraphic = "https://geoserver2.communitygis.net/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=" + layer + "&LEGEND_OPTIONS=forceLabels:on";
          wms_legend = L.wmsLegend(lagendGraphic);
        }
        function NonameBuildingFilter(feature) {
    // alert(layer.properties.name+"="+feature);
    // layer.on({click:onClick })
    if(feature.properties.building_name !== null) 
        return false    
    else
        return true
}
function NonameRegionFilter(feature){
    if(feature.properties.region !== null)
        return false
    else    
        return true
}
var feature;
    var $name,content ;
   
function Identify(e) {
 
    // set parameters needed for GetFeatureInfo WMS request
    var sw = mymap.options.crs.project(mymap.getBounds().getSouthWest());
    var ne = mymap.options.crs.project(mymap.getBounds().getNorthEast());
    var BBOX = sw.x + "," + sw.y + "," + ne.x + "," + ne.y;
    var WIDTH = mymap.getSize().x;
    var HEIGHT = mymap.getSize().y;

    var X = Math.trunc(mymap.layerPointToContainerPoint(e.layerPoint).x);
    var Y = Math.trunc(mymap.layerPointToContainerPoint(e.layerPoint).y);

    // compose the URL for the request
    
    
    var URL = popup_layer + '&BBOX=' + BBOX + '&FEATURE_COUNT=1&HEIGHT=' + HEIGHT + '&WIDTH=' + WIDTH + '&INFO_FORMAT=application%2Fjson&TILED=false&CRS=EPSG%3A3857&I=' + X + '&J=' + Y;
    //send GetFeatureInfo as asynchronous HTTP request using jQuery $.ajax
  
    $.ajax({
        url: URL,
        dataType: "json",
        type: "GET",
        success: function(data) {
          if (data.features.length !== 0) { // at least one feature returned in response
                var feature = data.features[0]; // first feature from response
                // Set up popup for clicked feature and open it
                var popup = new L.Popup({
                    maxWidth: 300
                });
                if (feature.properties.daily_wast) {
                    // alert("in region");
                    content = "<table class = 'popupclass'style ='border: 1px solid white' ><tr style ='border: 1px solid white'><td colspan=6><b>Bulk Waste Generator Info</b></td><td></td></tr>" +
                        "<tr style ='border: 1px solid white'><td colspan=3><b>Ward Name: </b></td><td style ='text-align:left;'>" + feature.properties.Ward_name + "</td></tr>"+
                        "<tr style ='border: 1px solid white'><td colspan=3><b>Address: </b></td><td>" + feature.properties.full_addre + "</td></tr>"+
                        "<tr style ='border: 1px solid white'><td colspan=3><b>Daily Waste: </b></td><td>" + feature.properties.daily_wast + "</td></tr>"+"</table>";
                    popup.setContent(content);
                    popup.setLatLng(e.latlng);
                    mymap.openPopup(popup);
                    }
                if (feature.properties.region) {
                    // alert("in region");
                    content = "<table class = 'popupclass' ><tr><td><b>Region Info</b></td><td></td></tr>" +
                        "<tr><td><b>Region Name: </b></td><td>" + feature.properties.region + "</td></tr>"+"</table>";
                    popup.setContent(content);
                    popup.setLatLng(e.latlng);
                    mymap.openPopup(popup);
                    }
                if (feature.properties.building_t) {

                 
                    

//                   <table border =2><tr class="bg-primary"><td colspan=2>Building Information</td></tr>
//     <tr class="table-danger"><td>Building Name:</td><td> ${feature.properties.building_name}</td></tr>
//     <tr><td>Building Type :</td><td>${feature.properties.building_type}</td></tr>
//     <tr class="table-danger"><td>Region:</td><td>${feature.properties.region}</td></tr>
//     <tr><td>Number of Flats :</td><td>${feature.properties.num_flat}</td></tr>
//     <tr class="table-danger"><td>Number of shops :</td><td>${feature.properties.num_shops}</td></tr>
//     <tr><td>Wing Name:</td><td>${feature.properties.wing_name}</td></tr>
//     <tr class="table-danger"><td>Address : </td><td>${feature.properties.addrstreet}</td></tr>
    
    
// `
// +
// `
// {% if request.user|has_group:"Editor" %}
//      <tr ><td colspan =2><b><center><a href = '/buildedit/${feature.properties.osm_id}' class="btn btn-info">Update Building Details</a></center></td></tr>
//      <tr ><td colspan =2 ><a href='/garbage_seg/' class="btn btn-success">Add Waste Segregation Details</a></td></tr></table>
// {% endif%}
// `+`</table>

                    // console.log(feature,"I reached at");
                //     content = "<table class = 'popupclass' ><tr><td><b>Buildings Info</b></td><td></td></tr>" +
                //         "<tr><td><b>SAC No.: </b></td><td>" + feature.properties.sac_no + "</td></tr>"+
                //         "<tr><td><b>Building Name: </b></td><td>" + feature.properties.building_name + "</td></tr>"+
                //         "<tr><td><b>Description: </b></td><td>"+feature.properties.building_type + "</td></tr>"+
                //         "<tr><td><b>Region: </b></td><td>" + feature.properties.region + "</td></tr>"+
                //         "<tr><td><b>Number of Flats: </b></td><td>" + feature.properties.num_flat + "</td></tr>"+
                //         "<tr><td><b>Number of shops: </b></td><td>" + feature.properties.num_shops + "</td></tr>"+
                //         "<tr><td><b>Number of Wings></td><td>" + feature.properties.wing_name + "</td></tr>"+
                //             "<tr><td><b>Village: </b></td><td>" + feature.properties.village + "</td></tr>"+
                //         "<tr><td><b>Address: </b></td><td>" + feature.properties.address + "</td></tr>"+
                //         // "<tr><td><b>MODIFY: </b></td><td><a href = '/buildedit/"+feature.properties.osm_id+"' style ='color:#FF0000;'>" + feature.properties.osm_id + "</a></td></tr>"+
                //         // "<tr><td rowspan=2><a href = '/buildedit/"+feature.properties.osm_id+"' style ='color:#FF0000;'>" + feature.properties.osm_id + "</a></td></tr>"+
                //         "{% if request.user|has_group:'Editor' %}"+
                //         "<tr ><td colspan =2><b><center><a href = '/buildedit/"+feature.properties.sac_no+"' class='btn btn-info'>Update Building Details</a></center></td></tr>"+
                //         "<tr ><td colspan =2 ><a href='/garbage_seg/' class='btn btn-success'>Add Waste Segregation Details</a></td></tr></table>"+
                //           "{% endif%}"
                //         "</table>";
                // popup.setContent(content);
                // popup.setLatLng(e.latlng);
                // mymap.openPopup(popup);

                $name= {
            
                'name': feature.properties.sac_number}
                new_ajax(e);
              
                // Set up popup for clicked feature and open it
                }
            }
        }
      
    });
  
  
   

}
function new_ajax(e){
  var $endpoint = window.location.href // or localhost/interface
  var popup = new L.Popup({
                    maxWidth: 300
                });
  $.ajax({
                method: "GET",
                url: $endpoint,
                data: $name,
                success: function(data) {
                           if (data.region) {
                    // alert("in region");
                    content = "<table class = 'popupclass' ><tr><td><b>Region Info</b></td><td></td></tr>" +
                        "<tr><td><b>Region Name: </b></td><td>" + data.region + "</td></tr>"+"</table>";
                    // popup.setContent(content);
                    // popup.setLatLng(e.latlng);
                    // mymap.openPopup(popup);
                    // return content;
                    }
                if (data.building_type) {
                    

//                   <table border =2><tr class="bg-primary"><td colspan=2>Building Information</td></tr>
//     <tr class="table-danger"><td>Building Name:</td><td> ${feature.properties.building_name}</td></tr>
//     <tr><td>Building Type :</td><td>${feature.properties.building_type}</td></tr>
//     <tr class="table-danger"><td>Region:</td><td>${feature.properties.region}</td></tr>
//     <tr><td>Number of Flats :</td><td>${feature.properties.num_flat}</td></tr>
//     <tr class="table-danger"><td>Number of shops :</td><td>${feature.properties.num_shops}</td></tr>
//     <tr><td>Wing Name:</td><td>${feature.properties.wing_name}</td></tr>
//     <tr class="table-danger"><td>Address : </td><td>${feature.properties.addrstreet}</td></tr>
    
    
// `
// +
// `
// {% if request.user|has_group:"Editor" %}
//      <tr ><td colspan =2><b><center><a href = '/buildedit/${feature.properties.osm_id}' class="btn btn-info">Update Building Details</a></center></td></tr>
//      <tr ><td colspan =2 ><a href='/garbage_seg/' class="btn btn-success">Add Waste Segregation Details</a></td></tr></table>
// {% endif%}
// `+`</table>

                    content = "<table class = 'popupclass' ><tr><td><b>Buildings Info</b></td><td></td></tr>" +
                        "<tr><td><b>SAC No.: </b></td><td>" + data.sac_number + "</td></tr>"+
                        "<tr><td><b>Building Name: </b></td><td>" + data.building_name + "</td></tr>"+
                        "<tr><td><b>Description: </b></td><td>"+data.building_type + "</td></tr>"+
                        "<tr><td><b>Region: </b></td><td>" + data.region + "</td></tr>"+
                        "<tr><td><b>Number of Flats: </b></td><td>" + data.num_flat + "</td></tr>"+
                        "<tr><td><b>Number of shops: </b></td><td>" + data.num_shops + "</td></tr>"+
                        "<tr><td><b>Number of Wings></td><td>" + data.wing_name + "</td></tr>"+
                            "<tr><td><b>Village: </b></td><td>" + data.village + "</td></tr>"+
                        "<tr><td><b>Billing Address: </b></td><td>" + data.address + "</td></tr>"+
                        "<tr><td><b>Property Address: </b></td><td>" + data.prop_add + "</td></tr>"+
                        // "<tr><td><b>MODIFY: </b></td><td><a href = '/buildedit/"+data.osm_id+"' style ='color:#FF0000;'>" + data.osm_id + "</a></td></tr>"+
                        // "<tr><td rowspan=2><a href = '/buildedit/"+data.osm_id+"' style ='color:#FF0000;'>" + data.osm_id + "</a></td></tr>"+
                        "{% if request.user|has_group:'Editor' %}"+
                        "<tr ><td colspan =2><b><center><a href = '/buildedit/"+ data.sac_no + "' class='btn btn-info'>Update Building Details</a></center></td></tr>"+
                        "<tr ><td colspan =2 ><a href='/garbage_seg/' class='btn btn-success'>Add Waste Segregation Details</a></td></tr></table>"+
                          "{% endif%}"
                        "</table>";
            //  return content;
                }
                popup.setContent(content);
                popup.setLatLng(e.latlng);
                mymap.openPopup(popup);
            // $("#id_pic").val(data.picture.url);
        }
       ,
                error: handleFormError,
            })
  
}
 

        function handleFormError(jqXHR, textStatus, errorThrown) {
            console.log(jqXHR)
            console.log(textStatus)
            console.log(errorThrown)
        }
mymap.addEventListener('click', Identify);

      </script>
      {% endblock extra_map_javascript %}