{% extends 'map/map_base.html' %}
{% load static%}{% load has_group %}
{% block extra_map_css %}
{% load i18n %}
<!-- import psycopg2 -->
<style>
    .border {
      padding: 6px 8px;
      border-style: groove;
      border-radius: 5px;
      margin: 20px;
    }
  
    .info {
      padding: 6px 8px;
      font: 14px/16px Arial, Helvetica, sans-serif;
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
    }
  
    .info h4 {
      margin: 0 0 5px;
      color: #777;
    }
  
    /* .table{
    border-collapse: collapse;
    padding: 50px;
    font-weight: bold;
  
    
    /* background:rgba(191, 149, 233, 0.473); */
  
    /* } */
  
  
    /* table{
      width: 350px;
    } */
    th {
      border-bottom: 1px solid #ddd;
      border-collapse: collapse;
      width: 150px !important;
      
    }
  
    td {
      border-bottom: 1px solid #ddd;
      border-collapse: collapse;
      width: 250px !important;
      /* padding: 2px 3px; */
      /* text-align: center; */
    }
    table{
      border-bottom: 1px solid #ddd;
      border-collapse: collapse;
      width: 450px !important;
      /* padding: 2px 3px; */
      /* text-align: center; */
    }
  
    th {
      font-weight: bold;
    }
  
    .legend {
      line-height: 18px;
      color: #555;
    }
  
    .legend i {
  
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
  
    .legendwet {
      line-height: 18px;
      color: #555;
    }
  
    .legendwet i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
  
    /* css to customize Leaflet default styles  */
    .leaflet-popup-content-wrapper {
      width: 500px;
      background: rgba(0, 0, 0, 0.9);
      color: #ffffff;
    }
  
    .leaflet-popup-content {
      font-weight: bold;
    }
  
    /* css for table tbinfo*/
    #tbinfo {
      font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
      border-collapse: collapse;
      font-weight: bolder;
    }
  
    #tbinfo td,
    #tbinfo th {
      border: 3px solid #ddd;
      /* padding: 8px; */
    }
  
    #tbinfo tr:nth-child(even) {
      background-color: #f2f2f2;
    }
  
    #tbinfo tr:hover {
      background-color: rgb(194, 92, 92);
    }
  
    #tbinfo th {
      padding-top: 12px;
      padding-bottom: 12px;
      text-align: left;
      background-color: #4CAF50;
      color: white;
    }
  
    #checkboxes,#checkboxes1 {
      display: none;
      /* border: 1px #dadada solid; */
    }
  
    #datepick {
      display: none;
      /* border: 1px #dadada solid; */
    }
  #side-bar{
    min-height: min-content;
    max-height: 100%;
    margin: 0;
    overflow-y: scroll;
  }
#checkboxes label {
    display: block;
    text-decoration-color: blue;
    text-align: left;
    margin: 10px;
  }
#formBtn{
  background-color: rgb(131, 131, 241);
}

  #pln_whole,#sewage,#wetwaste,#borewell, #infrastructure {
    display: none;
    /* border: 1px #dadada solid; */
  }

  .legend{
    background-color: white;
  }
  
#pln_whole label,#sewage label, #wetwaste label,#borewell label,#infrastructure label select {
      display: block;
      text-align: left;
      margin: 10px;
    }

  
    
.required:after {
      content:" *";
      color: rgb(251, 4, 4);
      /* size:"6px"; */
      font-size:x-large;
      
    }
    
    /* Popup container - can be anything you want */
    .popup {
      position: relative;
      display: inline-block;
      cursor: pointer;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      left: 50%;
      margin-right: -5px;
      border-width: 5px;
    }
  
    /* The actual popup */
    .popup .popuptext {
      visibility: hidden;
      width: 260px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 8px 0;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -80px;
    }
  
    /* Popup arrow */
    .popup .popuptext::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #555 transparent transparent transparent;
    }
  
    /* Toggle this class - hide and show the popup */
    .popup .show {
      visibility: visible;
      -webkit-animation: fadeIn 1s;
      animation: fadeIn 1s;
    }
  
    /* Add animation (fade in the popup) */
    @-webkit-keyframes fadeIn {
      from {
        opacity: 0;
      }
  
      to {
        opacity: 1;
      }
    }
  
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
  
      to {
        opacity: 1;
      }
    }
  
    .form-control {
      width: 160px;
    }
  
    .circle {
      /* background-color: red; */
      border-radius: 50%;
    }
    .tab4 {
              tab-size: 8;
          }
  </style>
  
  {% endblock extra_map_css%}
  
  {% block map_content%}
  <!-- {% block sidebar %}
  {% endblock %} -->
  {% if messages %}
  <div>
  <ul class="messages">
      {% for message in messages %}
  
      <div class="alert alert-success alert-dismissible fade show" role="alert">
          {{message}}
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
      </div>
  
      {% endfor %}
  </ul>
  </div>
  {% endif %}

<div id="side-bar" style="background-color:  rgba(255, 255, 255);">
  <!-- side-bar container -->

  <div class="mobileShow">

    <div style="text-align: center">
      <button style="display: inline-block ;position: relative; background: #000; opacity: 0.60;" id="closebutton"
        name="closebutton" class="btn btn-secondary"><span class="fa fa-bars"></span></button>
    </div>

  </div><!--mobile show closses-->

  <div><!--Outer div inside Mobile Show-->
    <div class="text-center border"><!--Inner Div -->


      <form id="projectList" style="width: 100%">
          <div class="multiselect">

            <div class="selectBox" onclick="showCheckboxes3('pln')">
                <button type="button" class="btn btn-outline-dark" style="width: 90%;font-size:12px; "> {% trans "Powai Lake & it's Neighbours" %}</button>
                <div class="overSelect"></div>
            </div>

         
            <div id="pln_whole"><br>
                <div class="checkbox">
                  <label><input type="checkbox"  value="{powai_lake}" id="powai_lake" onclick="getBoundaryru(this)" ><span> {% trans "Lake Boundary" %}</span></label>
                </div>
                <div class="checkbox">
                  <label><input type="checkbox"  value="{mumbai_buildings}" id="mumbai_buildings" onclick="getBoundaryru(this)" disabled><span> {% trans "Historical Lake " %}</span></label>
                </div>
                <div class="checkbox">
                  <label><input type="checkbox" value="{mumbai_ward}" id="mumbai_ward" onchange="getBoundaryru(this)" ><span> {% trans "Ward Boundaries" %}</span></label>
                  </div>
                <div class="checkbox">
                  <label><input type="checkbox" value="{mumbai_prabhag}" id="mumbai_prabhag" onclick="getBoundaryru(this)"><span> {% trans "Prabhag Boundary" %}</span></label>
                  </div>
                <div class="checkbox">
                  <label><input type="checkbox" value="{water_bodies}" id="water_bodies" onclick="getBoundaryru(this)"><span> {% trans "Water Bodies" %}</span></label>
                  </div>
            </div><br>
            <!-- Powai Lake neighbour over -->
            
            <div class="selectBox" onclick="showCheckboxes3('infra')">
                <button type="button" class="btn btn-outline-dark" style="width: 90%;font-size:12px; "> {% trans "Infrastructure" %}</button>
                <div class="overSelect"></div>
            </div>
            
            <div id="infrastructure"><br>
                <div class="checkbox">
                  <label><input type="checkbox"  value="{mumbai_buildings}" id="mumbai_buildings" onchange="getBoundaryru(this)"><span> {% trans "Building Points" %}</span></label>
                </div>
                <div class="checkbox">
                  <label><input type="checkbox" value="{mumbai_roads}" id="mumbai_roads" onchange="getBoundaryru(this)"><span> {% trans "Road Network" %}</span></label>
                </div>

                <div class="checkbox">
                  <label><input type="checkbox" value="{landmarks}" id="landmarks" onchange="getBoundaryru(this)"><span> {% trans "Landmarks" %}</span></label>
                </div>
                <div class="checkbox">
                  <label><input type="checkbox" value="{gardens}" id="gardens" onchange="getBoundaryru(this)"><span> {% trans "Gardens" %}</span></label>
                </div>
                
                <div class="checkbox">
                  <label><input type="checkbox" value="{DP}" id="DP" onclick="putDP()" disabled><span> {% trans "Development Plan" %}</span></label>
                </div>
                <div class="checkbox">
                  <label><input type="checkbox"  value="{sc_coll}" id="sc_coll" onclick="getBoundaryru(this)" disabled><span> {% trans "Schools and Colleges" %}</span></label>
                </div>
                <div class="checkbox">
                  <label><input type="checkbox" value="{mumbai_prabhag}" id="mumbai_prabhag" onchange="getBoundaryru(this)" disabled><span> {% trans "Public Toilets" %}</span></label>
                </div>
                <div class="checkbox">
                  <label><input type="checkbox" value="{mumbai_prabhag}" id="mumbai_prabhag" onchange="getBoundaryru(this)" disabled><span> {% trans "Debris Truck unload points" %}</span></label>
                </div>
            </div>
                <!-- Infrastructure over  -->
          
          <div class="selectBox" onclick="showCheckboxes3('sewage')"><br>
              <button type="button" class="btn btn-outline-dark" style="width: 90%;font-size:12px; "> {% trans "Sewage & Drainage Details" %}</button>
              <div class="overSelect"></div>
            </div><!--sewage div closes-->
            
            <div id="sewage"><br>
              <div class="checkbox">
                <label><input type="checkbox"  value="{mumbai_buildings}" id="mumbai_buildings" onclick="getBoundaryru(this)" disabled><span> {% trans "Current Inlets" %}</span></label>
              </div>
              <div class="checkbox">
                <label><input type="checkbox"  value="{mumbai_buildings}" id="mumbai_buildings" onclick="getBoundaryru(this)" disabled><span> {% trans "Old and closed Inlets" %}</span></label>
              </div>
              
              <div class="checkbox">
                <label><input type="checkbox"  value="{mumbai_buildings}" id="mumbai_buildings" onclick="getBoundaryru(this)" disabled><span> {% trans "water channels for sewage" %}</span></label>
              </div>
              <div class="checkbox">
                <label><input type="checkbox"  value="{mumbai_buildings}" id="mumbai_buildings" onclick="getBoundaryru(this)" disabled><span> {% trans "Sewage Treatment Plants in Societies" %}</span></label>
              </div>
              <div class="checkbox">
                <label><input type="checkbox"  value="{storm_water}" id="storm_water" onclick="getBoundaryru(this)" ><span> {% trans "Storm Water Drainage (IIT-B) v1" %}</span></label>
              </div>
              <div class="checkbox">
                <label><input type="checkbox"  value="{storm_water_bed}" id="storm_water_bed" onclick="getBoundaryru(this)" ><span> {% trans "Storm Water Drain Bed (IIT-B) v1" %}</span></label>
              </div>
              <div class="checkbox">
                <label><input type="checkbox"  value="{sewarage_line}" id="sewarage_line" onclick="getBoundaryru(this)" ><span> {% trans "Sewarage Line (IIT-B) v1" %}</span></label>
              </div>
              <div class="checkbox">
                <label><input type="checkbox"  value="{sewarage_assets}" id="sewarage_assets" onclick="getBoundaryru(this)" ><span> {% trans "Sewarage Assets (IIT-B) v1" %}</span></label>
              </div>
            </div><!--sewage div id closes-->
            <div class="selectBox" onclick="showCheckboxes3('borewell')"><br>
              <button type="button" class="btn btn-outline-dark" style="width: 90%;font-size:12px; "> {% trans "Borewell" %}</button>
              <div class="overSelect"></div>
             </div><!--selectbox div closes-->
            <!-- <div id="borewell"><br> -->
              <!-- <div class="checkbox">
                <label><input type="checkbox"  value="{mumbai_buildings}" id="mumbai_buildings" onclick="getBoundaryru(this)" disabled><span> {% trans "Inlets" %}</span></label>
              </div>
              <div class="checkbox">
                <label><input type="checkbox"  value="{mumbai_buildings}" id="mumbai_buildings" onclick="getBoundaryru(this)" disabled><span> {% trans "Old Inlets" %}</span></label>
              </div>
              <div class="checkbox">
                <label><input type="checkbox"  value="{mumbai_buildings}" id="mumbai_buildings" onclick="getBoundaryru(this)" disabled><span> {% trans "Closed Inlets" %}</span></label>
              </div> -->
            <!--borewell div id closes-->  
            <div class="selectBox" onclick="showCheckboxes3('wb')"><br>
              <button type="button" class="btn btn-outline-dark" style="width: 90%;font-size:12px; "> {% trans "Water Bodies" %}</button>
              <div class="overSelect"></div>
            </div>
            <div class="selectBox" onclick="showCheckboxes3('fn')"><br>
              <button type="button" class="btn btn-outline-dark" style="width: 90%;font-size:12px; "> {% trans "Firshermen Nets" %}</button>
              <div class="overSelect"></div>
            </div>
            <div class="selectBox" onclick="showCheckboxes3('wa')"><br>
              <button type="button" class="btn btn-outline-dark" style="width: 90%;font-size:12px; "> {% trans "Water Analysis" %}</button>
              <div class="overSelect"></div>
            </div>
            <div class="selectBox" onclick="showCheckboxes3('ww')"><br>
              <button type="button" class="btn btn-outline-dark" style="width: 90%;font-size:12px; "> {% trans "Wet Waste Generator" %}</button>
              <div class="overSelect"></div>
            </div><br>
            <div id="wetwaste">
              <div class="checkbox">
                <label><input type="checkbox"  value="{mumbai_buildings}" id="mumbai_buildings" onclick="getBoundaryru(this)" disabled><span> {% trans "Food Stall /canteens" %}</span></label>
              </div>
              <div class="checkbox">
                <label><input type="checkbox"  value="{mumbai_buildings}" id="mumbai_buildings" onclick="getBoundaryru(this)" disabled><span> {% trans "Hotels" %}</span></label>
              </div>
              <div class="checkbox">
                <label><input type="checkbox"  value="{mumbai_buildings}" id="mumbai_buildings" onclick="getBoundaryru(this)" disabled><span> {% trans "Commercial Outlets" %}</span></label>
              </div>
            </div><!--wetwaste div closed-->

            
          </div><!--multiselect div closes-->
      <br>
      
    </div><!--Inner Div Closses-->
        
    </form>
    <form method="post">
      {% csrf_token %}
    <input type="button" name='mybtn1' style="align-items: center;" class="btn btn-primary" onclick="location.href=`{% url 'plr_report' %}`"
value="Report"></input>
<br/>
    </div><!--Outer div closses-->
  </div><!--sidebar div closses-->

        
{% endblock map_content%}


{% block extra_map_javascript%}
  <script src="{% static 'tilelayer-leaflet.js' %}"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="https://d3js.org/d3.v4.js"></script>
  
  <script>
      let expanded = false;
      showLegend = true;  // default value showing the legend
      let newLayerList = [];
      let newLegendList = [];
      var legend = L.control({position: 'bottomright'});

      // legend.onAdd = function (mymap) {
      //       var div = L.DomUtil.create('div', 'info legend');
      //       div.innerHTML = '<img src="" alt="Legend" id="legend-image" />';
      //       return div;
      //     };
      // legend.addTo(mymap);
      
      // function updateLegend(layerName) {
      //       var legendImage = document.getElementById('legend-image');
      //       legendImage.src = wmsUrl +
      //         '?REQUEST=GetLegendGraphic' +
      //         '&VERSION=1.0.0' +
      //         '&FORMAT=image/png' +
      //         '&LAYER=' + layerName;

      //       legend.update();
      // }


      function showCheckboxes3(th) {
          
            let checkboxes;
            if (th == 'pln') {
              checkboxes = document.getElementById("pln_whole");
            }
            if (th == 'sewage') {
              checkboxes = document.getElementById("sewage");
            }
            if (th == 'ww') {
              checkboxes = document.getElementById("wetwaste");
            }
            if (th == 'infra') {
              checkboxes = document.getElementById("infrastructure");
            }
            if(!expanded){
              checkboxes.style.display = "block";
              expanded = true;
            } else {
              checkboxes.style.display = "none";
              expanded = false;
            }

          }


      function getBoundaryru(obj) {
          
          let boundary = obj.value;
          console.log("boundary is :"+boundary);
          if ($(obj).is(":checked")) {
             if (boundary == "{mumbai_ward}"){
                putWMSru("mumbai_ward_boundary_2Jan2022");
                

             }
             if (boundary == "{mumbai_prabhag}"){
                putWMSru("Mumbai_Prabhag_Boundaries_3Jan2022V2");
                // updateLegend('Mumbai_Prabhag_Boundaries_3Jan2022V2');
             }
             if (boundary == "{mumbai_buildings}")
                putWMSru("buildings_mumbai_30mar23");
             if (boundary == "{mumbai_roads}")
                putWMSru("mumbai_roads_prabhag_wise_29jan");
             if (boundary == "{powai_lake}")
                putWMSru("powai_lake"); 
             if (boundary == "{landmarks}")
                putWMSru("Landmarks");
             if (boundary == "{storm_water}")
                putWMSru("storm_water_drain_1"); 
             if (boundary == "{storm_water_bed}")
                putWMSru("storm_water_drain_bed_1"); 
             if (boundary == "{sewarage_line}")
                putWMSru("sewarage_line_1"); 
             if (boundary == "{sewarage_assets}")
                putWMSru("sewarage_assets_1");  
             if(boundary == "{water_bodies}")
                putfrmgeoserver("water_bodies_v1")
             if(boundary == "{gardens}")
                putfrmgeoserver("gardens_nr_powai_lake") 
          } 
          else {
            if(boundary == "{mumbai_ward}")
              removeWMS('mumbai_ward_boundary_2Jan2022')
            if (boundary == "{mumbai_prabhag}")
              removeWMS("Mumbai_Prabhag_Boundaries_3Jan2022V2");
                // updateLegend('Mumbai_Prabhag_Boundaries_3Jan2022V2');
            if (boundary == "{mumbai_buildings}")
              removeWMS("buildings_mumbai_30mar23");
            if (boundary == "{mumbai_roads}")
              removeWMS("mumbai_roads_prabhag_wise_29jan");
            if (boundary == "{powai_lake}")
              removeWMS("powai_lake"); 
            if (boundary == "{landmarks}")
              removeWMS("Landmarks"); 
            if(boundary == "{water_bodies}")
              removeWMS("water_bodies_v1")
            if(boundary == "{gardens}")
              removeWMS("gardens_nr_powai_lake") 
            if (boundary == "{storm_water}")
              removeWMS("storm_water_drain_1");
            if (boundary == "{storm_water_bed}")
              removeWMS("storm_water_drain_bed_1"); 
            if (boundary == "{sewarage_line}")
              removeWMS("sewarage_line_1"); 
            if (boundary == "{sewarage_assets}")
              removeWMS("sewarage_assets_1"); 
          } 
      }
      
      function removeWMS(unchecked_layer) {
          // alert("in removeWMS unchecked layer is  "+unchecked_layer);
          newLayerList.forEach((layer, index) => {
            if (layer.options.layers === unchecked_layer) {
             
              mymap.removeLayer(layer);
              newLayerList.splice(index, 1);
              // removeWMS(unchecked_layer)
              
            }
          });
          
        }

      function putfrmgeoserver(layer){
        layer1 =layer;
          let newLayerList = [];
          var wms_legend;
          var sld = '';
          var cql = 'INCLUDE';
          var legend = L.control({position: 'bottomright'});
          


          console.log("Putwmsru- layer is "+layer);
          if (layer == "gardens_nr_powai_lake"){
            console.log("in gardens ")
            var currentPos = [19.122, 72.9];
            var maximumzoom = 20;
            var opac = 1.6;
            var zoom = 15;
            // var cql =`ward_name_='S' OR  ward_name_='L'`;
            // sld = "lake_boundary";
          }
          if (layer == "water_bodies_v1"){
            console.log("in water bodies ")
            var currentPos = [19.122, 72.9];
            var maximumzoom = 20;
            var opac = 1.6;
            var zoom = 15;
            // var cql =`ward_name_='S' OR  ward_name_='L'`;
            // sld = "lake_boundary";
          }

          var wms_layer1 = L.tileLayer.wms('https://geoserver2.communitygis.net/geoserver/wms', {
            layers: layer,
            format: 'image/png',
            opacity: opac,
            transparent: true,
            maxZoom: maximumzoom,
            cql_filter:cql,
            styles: sld,

          });
          wms_layer1.addTo(mymap);
          mymap.setView(currentPos, zoom);
          newLayerList.push(wms_layer1);
          popup_layer =  "https://geoserver2.communitygis.net/geoserver/"+layer.split(":")[0]+"/wms?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&LAYERS=" + wms_layer1.options.layers + "&QUERY_LAYERS=" + wms_layer1.options.layers;
         

          if (wms_legend) {
            mymap.removeControl(wms_legend);
          }

          addWMSLegend(layer,sld);
          newLegendList.push(wms_legend)
        }
       
      function putWMSru(layer) {
          layer1 =layer;
          
          var wms_legend;
          var sld = '';
          var cql = 'INCLUDE';
          var legend = L.control({position: 'bottomright'});
          
          console.log("Putwmsru- layer is "+layer);
          if (layer == "mumbai_ward_boundary_2Jan2022"){
            console.log("in ward ")
            var currentPos = [19.1467, 72.8283];
            var maximumzoom = 20;
            var opac = 1.6;
            var zoom = 12;
            var cql =`ward_name_='S' OR  ward_name_='L'`;
            sld = "mumbai_ward_boundary_2Jan2022";
          }
          if (layer == "Mumbai_Prabhag_Boundaries_3Jan2022V2"){
            console.log("in prahbag ")
            var currentPos = [19.1263, 72.8921];
            var maximumzoom = 20;
            var opac = 1.6;
            var zoom = 14;
            cql =`prabhag_no='121' OR prabhag_no ='122' OR prabhag_no='156' OR prabhag_no ='157'`;
            sld = "prabhag_boundary";
          }
          if (layer == "buildings_mumbai_30mar23"){
            console.log("in buildings ")
            var currentPos = [19.1262, 72.9048];
            var maximumzoom = 20;
            var opac = 1.6;
            var zoom = 14;
            cql =`prabhag_no='121' OR prabhag_no ='122' OR prabhag_no='156' OR prabhag_no ='157'`;
            // sld = "mumbai_ward_boundary_2Jan2022";
          }
          if (layer == "mumbai_roads_prabhag_wise_29jan"){
            console.log("in roads ")
            var currentPos = [19.1262, 72.9048];
            var maximumzoom = 20;
            var opac = 1.6;
            var zoom = 14;
            cql =`prabhag_no='121' OR prabhag_no ='122' OR prabhag_no='156' OR prabhag_no ='157'`;
            // sld = "mumbai_ward_boundary_2Jan2022";
          }
          if (layer == "powai_lake"){
            console.log("in lake boundary ")
            var currentPos = [19.1262, 72.9048];
            var maximumzoom = 20;
            var opac = 1.6;
            var zoom = 14;
            // cql =`prabhag_no='121' OR prabhag_no ='122' OR prabhag_no='156' OR prabhag_no ='157'`;
            sld = "lake_boundary";
          }
          if (layer == "Landmarks"){
            console.log("in landmarks ")
            var currentPos = [19.1262, 72.9048];
            var maximumzoom = 20;
            var opac = 1.6;
            var zoom = 14;
            // cql =`prabhag_no='121' OR prabhag_no ='122' OR prabhag_no='156' OR prabhag_no ='157'`;
            sld = "landmarks_powai";
          }
          if (layer == "storm_water_drain_1"){
            console.log("in storm water ")
            var currentPos = [19.1318, 72.9119];
            var maximumzoom = 20;
            var opac = 1.6;
            var zoom = 15;
            // cql =`prabhag_no='121' OR prabhag_no ='122' OR prabhag_no='156' OR prabhag_no ='157'`;
            // sld = "landmarks_powai";
          }
          if (layer == "storm_water_drain_bed_1"){
            console.log("in storm water bed ")
            var currentPos = [19.1318, 72.9119];
            var maximumzoom = 20;
            var opac = 1.6;
            var zoom = 16;
            // cql =`prabhag_no='121' OR prabhag_no ='122' OR prabhag_no='156' OR prabhag_no ='157'`;
            // sld = "landmarks_powai";
          }
          if (layer == "sewarage_assets_1"){
            console.log("in sewarage assets ")
            var currentPos = [19.1318, 72.9119];
            var maximumzoom = 20;
            var opac = 1.6;
            var zoom = 16;
            // cql =`prabhag_no='121' OR prabhag_no ='122' OR prabhag_no='156' OR prabhag_no ='157'`;
            // sld = "landmarks_powai";
          }
          if (layer == "sewarage_line_1"){
            console.log("in sewarage line ")
            var currentPos = [19.1318, 72.9119];
            var maximumzoom = 20;
            var opac = 1.6;
            var zoom = 15;
            // cql =`prabhag_no='121' OR prabhag_no ='122' OR prabhag_no='156' OR prabhag_no ='157'`;
            // sld = "landmarks_powai";
          }
      
      
          var wms_layer = L.tileLayer.wms('https://geonode.communitygis.in/geoserver/wms', {
            layers: layer,
            format: 'image/png',
            opacity: opac,
            transparent: true,
            maxZoom: maximumzoom,
            cql_filter:cql,
            styles: sld,

          });
          wms_layer.addTo(mymap);
          mymap.setView(currentPos, zoom);
          newLayerList.push(wms_layer);
          popup_layer =  "https://geonode.communitygis.in/geoserver/wms?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&LAYERS=" + wms_layer.options.layers + "&QUERY_LAYERS=" + wms_layer.options.layers;
         

          if (wms_legend) {
            mymap.removeControl(wms_legend);
          }

          addWMSLegend(layer,sld);
          
        }

        function addWMSLegend(layer,style) {     
          // alert(style)             
          // Layer styling without feature count
          
          if(layer =='Mumbai_Prabhag_Boundaries_3Jan2022V2' || layer == 'mumbai_ward_boundary_2Jan2022'){
            lagendGraphic = "https://geonode.communitygis.in/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=" + layer + "&STYLE="+style+"&LEGEND_OPTIONS=forceLabels:on;fontAntiAliasing:true;border:true;";
          }
          else //layer boundary with feature count
            lagendGraphic = "https://geonode.communitygis.in/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=" + layer + "&STYLE="+style+"&LEGEND_OPTIONS=forceLabels:on;countMatched:true;fontAntiAliasing:true;border:true;";
         
          wms_legend = L.wmsLegend(lagendGraphic);        
          
        }  
        function Identify(e) {
 
          // set parameters needed for GetFeatureInfo WMS request
          var sw = mymap.options.crs.project(mymap.getBounds().getSouthWest());
          var ne = mymap.options.crs.project(mymap.getBounds().getNorthEast());
          var BBOX = sw.x + "," + sw.y + "," + ne.x + "," + ne.y;
          var WIDTH = mymap.getSize().x;
          var HEIGHT = mymap.getSize().y;

          var X = Math.trunc(mymap.layerPointToContainerPoint(e.layerPoint).x);
          var Y = Math.trunc(mymap.layerPointToContainerPoint(e.layerPoint).y);

          // compose the URL for the request
          
          
          var URL = popup_layer + '&BBOX=' + BBOX + '&FEATURE_COUNT=1&HEIGHT=' + HEIGHT + '&WIDTH=' + WIDTH + '&INFO_FORMAT=application%2Fjson&TILED=false&CRS=EPSG%3A3857&I=' + X + '&J=' + Y;
          //send GetFeatureInfo as asynchronous HTTP request using jQuery $.ajax
          console.log("click",popup_layer,layer1)
          $.ajax({
              url: URL,
              dataType: "json",
              type: "GET",
              success: function(data) {
                
                if (data.features.length !== 0) { // at least one feature returned in response
                      var feature = data.features[0]; // first feature from response
                      // Set up popup for clicked feature and open it
                      console.log(feature);
                      var popup = new L.Popup({
                          maxWidth: 300
                      });
                    }
                if(feature.properties.sac_number){
                  content = "<table class = 'popupclass' ><tr><td><b>Buildings Info</b></td><td></td></tr>" +
                        "<tr><td><b>SAC No.: </b></td><td>" + feature.properties.sac_number + "</td></tr>"+
                        "<tr><td><b>Building Name: </b></td><td>" + feature.properties.building_n + "</td></tr>"+
                        "<tr><td><b>Description: </b></td><td>"+feature.properties.building_t + "</td></tr>"+
                        // "<tr><td><b>Road: </b></td><td>"+feature.properties.road + "</td></tr>"+
                        // "<tr><td><b>Region: </b></td><td>" + feature.properties.region + "</td></tr>"+
                        "<tr><td><b>Prabhag: </b></td><td>" + feature.properties.prabhag_no + "</td></tr>"+
                        "<tr><td><b>Ward: </b></td><td>" + feature.properties.ward_name_ + "</td></tr>"+
                        // "<tr><td><b>Bwg : </b></td><td>" + feature.properties.is_bwg + "</td></tr>"+
                        // "<tr><td><b>Bwg Type: </b></td><td>" + feature.properties.bwg_type + "</td></tr>"+
                        // "<tr><td><b>Composting: </b></td><td>" + feature.properties.is_compost + "</td></tr>"+
                        // "<tr><td><b>Composting Type : </b></td><td>" + feature.properties.compost_type + "</td></tr>"+
                        // "<tr><td><b>Number of Floors: </b></td><td>" + feature.properties.num_floors + "</td></tr>"+
                        "<tr><td><b>Number of Flats: </b></td><td>" + feature.properties.num_flat + "</td></tr>"+
                        "<tr><td><b>Number of shops: </b></td><td>" + feature.properties.num_shops + "</td></tr>"+
                        "<tr><td><b>Wing Name</td><td>" + feature.properties.wing_name + "</td></tr>"+
                            "<tr><td><b>Village: </b></td><td>" + feature.properties.village + "</td></tr>"+
                        "<tr><td><b>Property Address: </b></td><td>" + feature.properties.address + "</td></tr>"+
                        // "<tr><td><b>Population: </b></td><td>" +  feature.properties.population + "</td></tr>"+
                        // "<tr><td><b>Remarks: </b></td><td>" + feature.properties.remarks + "</td></tr>"+
                        // "<tr><td><b>Updated by: </b></td><td>" + feature.properties.updated_by + "</td></tr>"+
                        // "<tr><td><b>Update Date/Time: </b></td><td>" + feature.properties.update_time + "</td></tr>"+
                        // "<tr><td><b>MODIFY: </b></td><td><a href = '/buildedit/"+data.osm_id+"' style ='color:#FF0000;'>" + data.osm_id + "</a></td></tr>"+
                        // "<tr><td rowspan=2><a href = '/buildedit/"+data.osm_id+"' style ='color:#FF0000;'>" + data.osm_id + "</a></td></tr>"+
                        "{% if request.user|has_group:'Editor' %}"+
                        "<tr ><td colspan =2><b><center><a href = '/buildedit/"+ data.sac_no + "' class='btn btn-info'>Update Building Details</a></center></td></tr>"+
                        "<tr ><td colspan =2 ><a href='/garbage_seg/' class='btn btn-success'>Add Waste Segregation Details</a></td></tr></table>"+
                          "{% endif%}"
                        "</table>";

                }
                else{
                  console.log("in else part of identify function");
                }
                popup.setContent(content);
                popup.setLatLng(e.latlng);
                mymap.openPopup(popup);
                  }
                });
            }
            
        function toggleLegend(){
            var toggleLegend = function(){
                if(showLegend === true){
                /* use jquery to select your DOM elements that has the class 'legend' */
                  $('.legend').hide(); 
                  showLegend = false; 
                }else{
                  $('.legend').show();
                  showLegend = true; 
                }
              }
            }


  mymap.addEventListener('click', Identify);    
  </script>
{% endblock extra_map_javascript%}